-----

### **测试用例与验收标准文档 (TCD)**

  * **产品名称:** 高考志愿AI决策顾问 (MVP版)
  * **版本:** V1.1
  * **对应PRD/TD版本:** V1.1
  * **更新时间：2025-06-22

## 版本历史

- V1.1（2025-06-22）
    - 新增极简用户认证（邀请码/密码）与IP/Session限流相关测试
    - 增加多轮上下文追问功能相关测试
    - 增加背景数据导入、解析、异常处理相关测试
    - 增加配置项变更可用性测试


-----

#### **1. 测试策略与目标**

  * **测试目标:**

    1.  **功能正确性:** 确保产品的核心功能（信息提交 -\> AI分析 -\> 报告展示）在各种情况下都能正确工作。
    2.  **健壮性:** 确保系统在遇到异常输入或边界情况时，能优雅地处理，而不是崩溃。
    3.  **成本可控性:** **(最高优先级)** 确保“每日限额”的熔断机制100%可靠，防止API成本失控。

  * **测试策略:**

      * **后端单元/集成测试 (自动化):** 对核心逻辑（特别是成本控制和Prompt生成）进行严格的自动化测试。工程师可以将下面的用例描述，直接输入到AI编程工具（如Cursor）中，生成`pytest`测试代码。
      * **前端及端到端(E2E)测试 (手动):** 考虑到一天开发的极限周期，前端的视觉和简单交互，采用手动测试清单的方式最高效。

  * **推荐测试框架:**

      * **后端:** `pytest` (配合 `pytest-mock` 进行依赖模拟)。
      * **API测试:** 可使用`requests`库编写一个简单的Python脚本，或使用Postman等工具。

-----

#### **2. 后端自动化测试用例 (for `api/handler.py`)**

**测试文件: `api/test_handler.py`**

**测试用例 2.1: 核心数据处理与Prompt生成逻辑**

  * **目标:** 验证AI的“备课”流程是否正确。
  * **测试描述:** 编写一个单元测试函数`test_prepare_prompt_logic`。
      * **输入:** 模拟“王磊”的JSON数据，以及包含“华科计算机扩招5人”的`enrollment_data_2025.json`内容。
      * **断言 (Assert):**
        1.  函数生成的最终Prompt字符串**必须包含**以下关键词：“王磊”、“4500”、“复旦大学”、“华中科技大学”、“扩招5人”。
        2.  Prompt的结构应与技术文档中定义的模板一致。

**测试用例 2.2: 成本控制“熔断”机制 (最高优先级)**

  * **目标:** 验证每日限额功能在各种情况下都准确无误。
  * **测试描述:** 编写三个独立的测试函数，对部署为Flask App的API端点进行测试。使用`pytest-mock`模拟`vercel-kv`数据库和`openai`客户端的行为。
    1.  **`test_quota_available` (名额充足):**
          * **模拟:** `kv.get()` 返回 `500`。
          * **断言:** API应返回`200 OK`。`openai`客户端的`chat.completions.create`方法被调用一次。`kv.incr()`方法被调用一次。
    2.  **`test_quota_exhausted` (名额耗尽):**
          * **模拟:** `kv.get()` 返回 `1000` (或设定的上限值)。
          * **断言:** API应返回状态码`429`和一个包含`"今日名额已满"`信息的JSON。`openai`客户端不应被调用。
    3.  **`test_kv_database_error` (数据库异常):**
          * **模拟:** `kv.get()` 调用时直接 `raise Exception("Connection Error")`。
          * **断言:** API应返回状态码`500`和一个包含`"服务暂时不可用"`信息的JSON，确保程序不崩溃。

-----

#### **3. API端到端集成测试 (可自动化脚本/手动)**

**目标:** 测试部署到Vercel上的真实API端点的行为。

| 测试场景 | 请求体 (Body) | 预期HTTP状态码 | 预期响应体 (Response Body) |
| :--- | :--- | :--- | :--- |
| **正常请求** | 包含“王磊”完整信息的JSON | `200 OK` | JSON中包含`report`字段，且其内容为非空的Markdown字符串。 |
| **无效输入** | 一个空的JSON `{}` | `400 Bad Request` | JSON中包含`error`字段，内容为“请求数据无效或不完整”。 |
| **触发限额** | （在限额用完后）发送任何有效请求 | `429 Too Many Requests` | JSON中包含`error`字段，内容为“今日免费体验名额已全部发放完毕...”。 |

-----

#### **4. 前端手动验收清单**

**目标:** 确保用户直接感知的界面和交互流程顺畅、符合预期。

| 验收模块 | 操作步骤 | 预期结果 | 测试结果 (Pass/Fail) |
| :--- | :--- | :--- | :--- |
| **1. 响应式布局**| 在PC端浏览器中，使用开发者工具切换到iPhone 12/13和通用Android设备的视图。 | 页面布局无错乱，文字和按钮没有重叠或溢出。 | |
| **2. 信息提交** | 1. 尝试在文本框中粘贴一段长文本。\<br\>2. 尝试上传一个`.txt`文件。\<br\>3. 尝试上传一个`.jpg`图片。 | 1. 文本能正常显示。\<br\>2. 能识别文件名。\<br\>3. 能识别文件名。 | |
| **3. 等待状态** | 点击“生成报告”按钮。 | 按钮变为不可用，并清晰地显示“正在生成…”的等待动画和提示文案。 | |
| **4. 报告展示** | 使用“王磊”的案例进行一次成功的请求。 | 报告结果被清晰地渲染到页面上，表格、标题、加粗等Markdown格式正确显示。 | |
| **5. 熔断前端展示**| 1. 手动在Vercel KV后台将计数值设为1000。\<br\>2. 刷新H5页面并尝试提交。 | 页面不进入等待状态，而是直接显示“今日名额已满…”的提示文案。 | |

-----

#### **最终验收标准**

**当且仅当以下所有条件都满足时，产品视为通过验收，可以上线预热：**

1.  **所有后端自动化单元测试（测试用例2.x系列）全部通过。**
2.  **所有API端到端集成测试（测试用例3.x系列）全部符合预期。**
3.  **所有前端手动验收清单中的项目，测试结果均为“Pass”。**

---

## V1.1 新增测试用例

### 1. 用户认证与限流功能

#### 1.1 邀请码/密码认证测试

- **用例1.1.1**：输入正确的邀请码/密码，服务正常访问
- **用例1.1.2**：输入错误的邀请码/密码，访问被拒绝，返回错误提示

#### 1.2 IP/SessionId限流测试

- **用例1.2.1**：同一IP/同一session在短时间内频繁请求，超过阈值后被拒绝，返回限流提示
- **用例1.2.2**：不同IP/Session并发请求，互不影响，均可独立计数

---

### 2. 多轮上下文对话功能

#### 2.1 多轮追问测试

- **用例2.1.1**：用户首次提交后，连续追问2-3次，AI可准确带入历史上下文，响应合理
- **用例2.1.2**：调整config.json中的历史轮数参数后，新配置生效，历史追问轮数变化

#### 2.2 session存储测试

- **用例2.2.1**：每个会话（sessionId）独立保存为JSON文件，内容完整，轮次准确
- **用例2.2.2**：切换sessionId，新会话不会读取到旧会话的历史内容

---

### 3. 背景数据导入与异常处理

#### 3.1 正常数据导入

- **用例3.1.1**：上传符合规范的高考分数线/一分一段线JSON文件，后端可正常读取并用于分析
- **用例3.1.2**：替换为新数据文件，分析结果实时刷新，不需重启服务

#### 3.2 异常数据处理

- **用例3.2.1**：上传结构错误或缺失字段的JSON文件，后端能报错或给出友好提示，系统不崩溃

---

### 4. 配置项可用性

- **用例4.1**：修改config.json中的速率限制、认证方式、历史轮数等参数，服务重启后新配置生效

---

## V1.1 验收标准补充

- 所有V1.1新增功能有对应用例，均测试通过
- 用户认证、限流、对话历史、数据导入、配置变更等场景全覆盖
- 系统在异常数据和高并发场景下运行稳定

---
